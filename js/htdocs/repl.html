<html>
<head>
<title>Yarr</title>
<script>var require = false;</script>
<script src="namespace.js"></script>
<script src="runtime.js"></script>
<script src="moorings.js"></script>
<script src="CodeMirror/lib/codemirror.js"></script>
<script src="CodeMirror/mode/pyret/pyret.js"></script>
<link rel="stylesheet" href="CodeMirror/lib/codemirror.css"></link>
<style>
#the-editor {
}
#editor-pane {
  border : 1px solid black;
  float : left;
  width : 50%;
  height : 100%;
}
#output {
  float : left;
  border : 1px solid black;
  width : 40%;
}
</style>
</head>

<body>

<div>
  <div id="editor-pane">
    <button id="run">Run me!</button>
    <textarea id="the-editor"></textarea>
  </div>

  <div id="output"></div>
</div>

<script src="/jquery-1.9.1.min.js"></script>
<script>
"use strict";
$(function() {
  var cm = CodeMirror.fromTextArea($("#the-editor")[0], {
    viewportMargin: Infinity,
    extraKeys: { "Tab": "indentAuto" } });
  var base = "http://localhost:8080";
  var runtime = PYRET.makeRuntime();
  var extraIds = ["prim-read-sexpr", "equiv", "data-to-repr", "data-equals", "test-print"];
  var moorings = $.ajax("/moorings.arr", { type: "get"});
  var mooringsResult = LIB(runtime.runtime, runtime.namespace);
  if (!mooringsResult.namespace) {
    alert("Libraries failed to load with error: " + mooringsResult.exn.message);
  }
  $("#run").click(function() {
    var src = cm.getValue();
    var ids = mooringsResult.namespace.getNames();
    var compiled = $.ajax(base + "/compile", {
          type: "POST",
          datatype: "json",
          data: {
              src: src,
              options: JSON.stringify({ids: extraIds.concat(ids), check: true})
          }
        });
    var runResult = compiled.then(function(jsCode) {
        if (!jsCode["compiledCodes"]) {
          alert(jsCode["message"]);
          return;
        }
       
        return (1,eval)(jsCode["compiledCodes"])(
            runtime.runtime,
            runtime.namespace.merge(mooringsResult.namespace)
          );
      });
    runResult.then(function(r) {
        var str = runtime.runtime.applyFunc(runtime.runtime.getField(r.val, "format"), []);
        console.log(str);
        $("#output").append($("<pre>").text(str.s));
      });
  });

});
</script>
</body>
</html>
